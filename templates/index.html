<!DOCTYPE html>
<html>
<head>
    <title>Whisp Chat</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
<div id="usernameBox" class="centered">
    <h2>Enter your username</h2>
    <input id="usernameInput" placeholder="Username" />
    <button onclick="submitUsername()">Join Chat</button>
    <p id="error" style="color:red;"></p>
</div>

<div id="chatBox" style="display:none;">
    <div id="sidebar">
        <h3>Online</h3>
        <ul id="onlineUsers"></ul>
    </div>

    <div id="chat">
        <div id="messages"></div>

        <div id="inputArea">
            <input id="messageInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
const socket = io();
let username = null;

function submitUsername() {
    const name = document.getElementById("usernameInput").value.trim();

    if (name.length === 0) return;

    username = name;
    socket.emit("join", { username });
}

socket.on("username_taken", () => {
    document.getElementById("error").innerText = "âš  Username already exists!";
});

socket.on("join_success", (data) => {
    document.getElementById("usernameBox").style.display = "none";
    document.getElementById("chatBox").style.display = "flex";
    updateOnline(data.online);
});

socket.on("update_online", (data) => {
    updateOnline(data.online);
});

function updateOnline(list) {
    const userList = document.getElementById("onlineUsers");
    userList.innerHTML = "";
    list.forEach(u => {
        const li = document.createElement("li");
        li.innerText = u;
        userList.appendChild(li);
    });
}

function sendMessage() {
    const msg = document.getElementById("messageInput").value.trim();
    if (msg.length === 0) return;

    socket.emit("message", {
        username,
        message: msg
    });

    document.getElementById("messageInput").value = "";
}

socket.on("new_message", (data) => {
    const messages = document.getElementById("messages");

    const bubble = document.createElement("div");
    bubble.classList.add("bubble");

    if (data.username === username) {
        bubble.classList.add("me");
    } else {
        bubble.classList.add("other");
    }

    bubble.innerHTML = `
        <strong>${data.username}</strong><br>
        ${data.message}
        <div class="timestamp">${data.timestamp}</div>
    `;

    messages.appendChild(bubble);
    messages.scrollTop = messages.scrollHeight;
});
</script>
</body>
</html>
